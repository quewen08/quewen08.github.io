{"title":"如何通过以太坊智能合约来进行众筹（ICO）","slug":"ico-crowdsale","date":"2018-03-14T04:02:22.000Z","updated":"2022-10-19T14:40:00.256Z","comments":true,"path":"api/articles/ico-crowdsale.json","realPath":"/2018/ico-crowdsale/index/","excerpt":null,"covers":["/img/crowdsale_create.jpeg","/img/crowdsale_send_token.jpeg"],"cover":"/img/crowdsale_create.jpeg","content":"<p>前面我们有两遍文章写了如何发行代币，今天我们讲一下如何使用代币来公开募资，即编写一个募资合约。</p>\n<h2 id=\"写在前面\"><a href=\"#写在前面\" class=\"headerlink\" title=\"写在前面\"></a>写在前面</h2><p>本文所讲的代币是使用以太坊智能合约创建，阅读本文前，你应该对以太坊、智能合约有所了解，如果你还不了解，建议你先看<a href=\"/posts/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%8C%BA%E5%9D%97%E9%93%BE/%E4%BB%A5%E5%A4%AA%E5%9D%8A/2018-02-22-whatiseth.html\">以太坊是什么</a></p>\n<h2 id=\"众筹\"><a href=\"#众筹\" class=\"headerlink\" title=\"众筹\"></a>众筹</h2><p>先简单说下众筹的概念：一般是这样的，我一个非常好的想法，但是我没有钱来做这事，于是我把这个想法发给大家看，说：我做这件事需要5百万，大家有没有兴趣投些钱，如果大家在30天内投够了5百万我就开始做，到时大家都是原始股东，如果募资额不到5百万，大家投的钱就还给大家。</p>\n<p>现在ICO众筹已经被各路大佬拿来割韭菜而被玩坏了（不管有无达标，都把钱卷走）。</p>\n<p>其实区块链技术本事非常适合解决众筹的信任问题，借助于智能合约，可以实现当募资额完成时，募资款自动打到指定账户，当募资额未完成时，可退款。这个过程不需要看众筹大佬的人品，不用依靠第三方平台信用担保。</p>\n<h2 id=\"代币\"><a href=\"#代币\" class=\"headerlink\" title=\"代币\"></a>代币</h2><p>传统的众筹在参与之后通常不容易交易（参与之后无法转给其他人），而通过用代币来参与众筹，则很容易进行交易，众筹的参与人可随时进行买卖，待众筹项目实施完成的时候，完全根据代币持有量进行回馈。</p>\n<p>举个例子说明下，大家会更容易理解，有这一个众筹：A有技术做一个能监测健康的指环，为此向公众募资200百万，募资时100块对应一个代币，约定在指环上市之后，代币的持有人可以用一个代币来兑换一个指环。而指环的研发周期是一年，因此在指环还未上市的一年里，众筹的参与人可以随时交易所持有的代币。</p>\n<h2 id=\"众筹智能合约代码\"><a href=\"#众筹智能合约代码\" class=\"headerlink\" title=\"众筹智能合约代码\"></a>众筹智能合约代码</h2><p>接下来就看看如何实现一个众筹智能合约：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^<span class=\"number\">0.4</span><span class=\"number\">.16</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">interface token &#123;</span><br><span class=\"line\">    <span class=\"keyword\">function</span> <span class=\"title function_\">transfer</span>(<span class=\"params\">address receiver, uint amount</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract <span class=\"title class_\">Crowdsale</span> &#123;</span><br><span class=\"line\">    address public beneficiary;  <span class=\"comment\">// 募资成功后的收款方</span></span><br><span class=\"line\">    uint public fundingGoal;   <span class=\"comment\">// 募资额度</span></span><br><span class=\"line\">    uint public amountRaised;   <span class=\"comment\">// 参与数量</span></span><br><span class=\"line\">    uint public deadline;      <span class=\"comment\">// 募资截止期</span></span><br><span class=\"line\"></span><br><span class=\"line\">    uint public price;    <span class=\"comment\">//  token 与以太坊的汇率 , token卖多少钱</span></span><br><span class=\"line\">    token public tokenReward;   <span class=\"comment\">// 要卖的token</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">mapping</span>(<span class=\"function\"><span class=\"params\">address</span> =&gt;</span> uint256) public balanceOf;</span><br><span class=\"line\"></span><br><span class=\"line\">    bool fundingGoalReached = <span class=\"literal\">false</span>;  <span class=\"comment\">// 众筹是否达到目标</span></span><br><span class=\"line\">    bool crowdsaleClosed = <span class=\"literal\">false</span>;   <span class=\"comment\">//  众筹是否结束</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * 事件可以用来跟踪信息</span></span><br><span class=\"line\"><span class=\"comment\">    **/</span></span><br><span class=\"line\">    event <span class=\"title class_\">GoalReached</span>(address recipient, uint totalAmountRaised);</span><br><span class=\"line\">    event <span class=\"title class_\">FundTransfer</span>(address backer, uint amount, bool isContribution);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 构造函数, 设置相关属性</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">function</span> <span class=\"title function_\">Crowdsale</span>(<span class=\"params\"></span></span><br><span class=\"line\"><span class=\"params\">        address ifSuccessfulSendTo,</span></span><br><span class=\"line\"><span class=\"params\">        uint fundingGoalInEthers,</span></span><br><span class=\"line\"><span class=\"params\">        uint durationInMinutes,</span></span><br><span class=\"line\"><span class=\"params\">        uint finneyCostOfEachToken,</span></span><br><span class=\"line\"><span class=\"params\">        address addressOfTokenUsedAsReward</span>) &#123;</span><br><span class=\"line\">            beneficiary = ifSuccessfulSendTo;</span><br><span class=\"line\">            fundingGoal = fundingGoalInEthers * <span class=\"number\">1</span> ether;</span><br><span class=\"line\">            deadline = now + durationInMinutes * <span class=\"number\">1</span> minutes;</span><br><span class=\"line\">            price = finneyCostOfEachToken * <span class=\"number\">1</span> finney;</span><br><span class=\"line\">            tokenReward = <span class=\"title function_\">token</span>(addressOfTokenUsedAsReward);   <span class=\"comment\">// 传入已发布的 token 合约的地址来创建实例</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 无函数名的Fallback函数，</span></span><br><span class=\"line\"><span class=\"comment\">     * 在向合约转账时，这个函数会被调用</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">function</span> (<span class=\"params\"></span>) payable &#123;</span><br><span class=\"line\">        <span class=\"built_in\">require</span>(!crowdsaleClosed);</span><br><span class=\"line\">        uint amount = msg.<span class=\"property\">value</span>;</span><br><span class=\"line\">        balanceOf[msg.<span class=\"property\">sender</span>] += amount;</span><br><span class=\"line\">        amountRaised += amount;</span><br><span class=\"line\">        tokenReward.<span class=\"title function_\">transfer</span>(msg.<span class=\"property\">sender</span>, amount / price);</span><br><span class=\"line\">        <span class=\"title class_\">FundTransfer</span>(msg.<span class=\"property\">sender</span>, amount, <span class=\"literal\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    *  定义函数修改器modifier（作用和Python的装饰器很相似）</span></span><br><span class=\"line\"><span class=\"comment\">    * 用于在函数执行前检查某种前置条件（判断通过之后才会继续执行该方法）</span></span><br><span class=\"line\"><span class=\"comment\">    * _ 表示继续执行之后的代码</span></span><br><span class=\"line\"><span class=\"comment\">    **/</span></span><br><span class=\"line\">    modifier <span class=\"title function_\">afterDeadline</span>(<span class=\"params\"></span>) &#123; <span class=\"keyword\">if</span> (now &gt;= deadline) _; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 判断众筹是否完成融资目标， 这个方法使用了afterDeadline函数修改器</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">function</span> <span class=\"title function_\">checkGoalReached</span>(<span class=\"params\"></span>) afterDeadline &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (amountRaised &gt;= fundingGoal) &#123;</span><br><span class=\"line\">            fundingGoalReached = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            <span class=\"title class_\">GoalReached</span>(beneficiary, amountRaised);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        crowdsaleClosed = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 完成融资目标时，融资款发送到收款方</span></span><br><span class=\"line\"><span class=\"comment\">     * 未完成融资目标时，执行退款</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">function</span> <span class=\"title function_\">safeWithdrawal</span>(<span class=\"params\"></span>) afterDeadline &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!fundingGoalReached) &#123;</span><br><span class=\"line\">            uint amount = balanceOf[msg.<span class=\"property\">sender</span>];</span><br><span class=\"line\">            balanceOf[msg.<span class=\"property\">sender</span>] = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (amount &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (msg.<span class=\"property\">sender</span>.<span class=\"title function_\">send</span>(amount)) &#123;</span><br><span class=\"line\">                    <span class=\"title class_\">FundTransfer</span>(msg.<span class=\"property\">sender</span>, amount, <span class=\"literal\">false</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    balanceOf[msg.<span class=\"property\">sender</span>] = amount;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (fundingGoalReached &amp;&amp; beneficiary == msg.<span class=\"property\">sender</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (beneficiary.<span class=\"title function_\">send</span>(amountRaised)) &#123;</span><br><span class=\"line\">                <span class=\"title class_\">FundTransfer</span>(beneficiary, amountRaised, <span class=\"literal\">false</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//If we fail to send the funds to beneficiary, unlock funders balance</span></span><br><span class=\"line\">                fundingGoalReached = <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"部署及说明\"><a href=\"#部署及说明\" class=\"headerlink\" title=\"部署及说明\"></a>部署及说明</h2><p>在部署这个合约之前，我们需要先部署一个代币合约，请参考一步步教你创建自己的数字货币。</p>\n<ol>\n<li>创建众筹合约我们需要提供一下几个参数：<br>ifSuccessfulSendTo： 募资成功后的收款方（其实这里可以默认为合约创建者）<br>fundingGoalInEthers： 募资额度， 为了方便我们仅募3个ether<br>durationInMinutes： 募资时间<br>finneyCostOfEachToken 每个代币的价格, 这里为了方便使用了单位finney及值为：1 （1 ether &#x3D; 1000 finney）<br>addressOfTokenUsedAsReward： 代币合约地址。<br>如：</li>\n</ol>\n<p>  <img src=\"/img/crowdsale_create.jpeg\"></p>\n<pre><code> 本文使用的参数为：\n\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;0xc6f9ea59d424733e8e1902c7837ea75e20abfb49&quot;,3, 100, 1,&quot;0xad8972e2b583f580fc52f737b98327eb65d08f8c&quot;</span><br></pre></td></tr></table></figure>\n</code></pre>\n<ol start=\"2\">\n<li>参与人投资的时候实际购买众筹合约代币，所有需要先向合约预存代币，代币的数量为：募资额度 &#x2F; 代币的价格 ， 这里为：3 * 1000&#x2F;1 &#x3D; 3000 （当能也可以大于3000）。<br>向合约预存代币可以使用<a href=\"https://www.myetherwallet.com/#send-transaction\">myetherwallet</a>钱包，或在remix中重新加载代币合约，执行代币合约tranfer()函数进行代币转账。如使用myetherwallet转账如图：</li>\n</ol>\n<p>  <img src=\"/img/crowdsale_send_token.jpeg\"></p>\n<ol start=\"3\">\n<li><p>参参与人投资行为即是向买众筹合约转账，转账时，会执行Fallback回退函数（即无名函数）向其账户打回相应的代币。</p>\n</li>\n<li><p>safeWithdrawl() 可以被参与人或收益人执行，如果融资不达标参与人可收回之前投资款，如果融资达标收益人可以拿到所有的融资款。</p>\n</li>\n</ol>\n<h2 id=\"参考文档\"><a href=\"#参考文档\" class=\"headerlink\" title=\"参考文档\"></a>参考文档</h2><ul>\n<li><a href=\"https://ethereum.org/crowdsale\">Create a crowdsale</a></li>\n</ul>\n","more":"<p>前面我们有两遍文章写了如何发行代币，今天我们讲一下如何使用代币来公开募资，即编写一个募资合约。</p>\n<h2 id=\"写在前面\"><a href=\"#写在前面\" class=\"headerlink\" title=\"写在前面\"></a>写在前面</h2><p>本文所讲的代币是使用以太坊智能合约创建，阅读本文前，你应该对以太坊、智能合约有所了解，如果你还不了解，建议你先看<a href=\"/posts/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%8C%BA%E5%9D%97%E9%93%BE/%E4%BB%A5%E5%A4%AA%E5%9D%8A/2018-02-22-whatiseth.html\">以太坊是什么</a></p>\n<h2 id=\"众筹\"><a href=\"#众筹\" class=\"headerlink\" title=\"众筹\"></a>众筹</h2><p>先简单说下众筹的概念：一般是这样的，我一个非常好的想法，但是我没有钱来做这事，于是我把这个想法发给大家看，说：我做这件事需要5百万，大家有没有兴趣投些钱，如果大家在30天内投够了5百万我就开始做，到时大家都是原始股东，如果募资额不到5百万，大家投的钱就还给大家。</p>\n<p>现在ICO众筹已经被各路大佬拿来割韭菜而被玩坏了（不管有无达标，都把钱卷走）。</p>\n<p>其实区块链技术本事非常适合解决众筹的信任问题，借助于智能合约，可以实现当募资额完成时，募资款自动打到指定账户，当募资额未完成时，可退款。这个过程不需要看众筹大佬的人品，不用依靠第三方平台信用担保。</p>\n<h2 id=\"代币\"><a href=\"#代币\" class=\"headerlink\" title=\"代币\"></a>代币</h2><p>传统的众筹在参与之后通常不容易交易（参与之后无法转给其他人），而通过用代币来参与众筹，则很容易进行交易，众筹的参与人可随时进行买卖，待众筹项目实施完成的时候，完全根据代币持有量进行回馈。</p>\n<p>举个例子说明下，大家会更容易理解，有这一个众筹：A有技术做一个能监测健康的指环，为此向公众募资200百万，募资时100块对应一个代币，约定在指环上市之后，代币的持有人可以用一个代币来兑换一个指环。而指环的研发周期是一年，因此在指环还未上市的一年里，众筹的参与人可以随时交易所持有的代币。</p>\n<h2 id=\"众筹智能合约代码\"><a href=\"#众筹智能合约代码\" class=\"headerlink\" title=\"众筹智能合约代码\"></a>众筹智能合约代码</h2><p>接下来就看看如何实现一个众筹智能合约：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^<span class=\"number\">0.4</span><span class=\"number\">.16</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">interface token &#123;</span><br><span class=\"line\">    <span class=\"keyword\">function</span> <span class=\"title function_\">transfer</span>(<span class=\"params\">address receiver, uint amount</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract <span class=\"title class_\">Crowdsale</span> &#123;</span><br><span class=\"line\">    address public beneficiary;  <span class=\"comment\">// 募资成功后的收款方</span></span><br><span class=\"line\">    uint public fundingGoal;   <span class=\"comment\">// 募资额度</span></span><br><span class=\"line\">    uint public amountRaised;   <span class=\"comment\">// 参与数量</span></span><br><span class=\"line\">    uint public deadline;      <span class=\"comment\">// 募资截止期</span></span><br><span class=\"line\"></span><br><span class=\"line\">    uint public price;    <span class=\"comment\">//  token 与以太坊的汇率 , token卖多少钱</span></span><br><span class=\"line\">    token public tokenReward;   <span class=\"comment\">// 要卖的token</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">mapping</span>(<span class=\"function\"><span class=\"params\">address</span> =&gt;</span> uint256) public balanceOf;</span><br><span class=\"line\"></span><br><span class=\"line\">    bool fundingGoalReached = <span class=\"literal\">false</span>;  <span class=\"comment\">// 众筹是否达到目标</span></span><br><span class=\"line\">    bool crowdsaleClosed = <span class=\"literal\">false</span>;   <span class=\"comment\">//  众筹是否结束</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * 事件可以用来跟踪信息</span></span><br><span class=\"line\"><span class=\"comment\">    **/</span></span><br><span class=\"line\">    event <span class=\"title class_\">GoalReached</span>(address recipient, uint totalAmountRaised);</span><br><span class=\"line\">    event <span class=\"title class_\">FundTransfer</span>(address backer, uint amount, bool isContribution);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 构造函数, 设置相关属性</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">function</span> <span class=\"title function_\">Crowdsale</span>(<span class=\"params\"></span></span><br><span class=\"line\"><span class=\"params\">        address ifSuccessfulSendTo,</span></span><br><span class=\"line\"><span class=\"params\">        uint fundingGoalInEthers,</span></span><br><span class=\"line\"><span class=\"params\">        uint durationInMinutes,</span></span><br><span class=\"line\"><span class=\"params\">        uint finneyCostOfEachToken,</span></span><br><span class=\"line\"><span class=\"params\">        address addressOfTokenUsedAsReward</span>) &#123;</span><br><span class=\"line\">            beneficiary = ifSuccessfulSendTo;</span><br><span class=\"line\">            fundingGoal = fundingGoalInEthers * <span class=\"number\">1</span> ether;</span><br><span class=\"line\">            deadline = now + durationInMinutes * <span class=\"number\">1</span> minutes;</span><br><span class=\"line\">            price = finneyCostOfEachToken * <span class=\"number\">1</span> finney;</span><br><span class=\"line\">            tokenReward = <span class=\"title function_\">token</span>(addressOfTokenUsedAsReward);   <span class=\"comment\">// 传入已发布的 token 合约的地址来创建实例</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 无函数名的Fallback函数，</span></span><br><span class=\"line\"><span class=\"comment\">     * 在向合约转账时，这个函数会被调用</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">function</span> (<span class=\"params\"></span>) payable &#123;</span><br><span class=\"line\">        <span class=\"built_in\">require</span>(!crowdsaleClosed);</span><br><span class=\"line\">        uint amount = msg.<span class=\"property\">value</span>;</span><br><span class=\"line\">        balanceOf[msg.<span class=\"property\">sender</span>] += amount;</span><br><span class=\"line\">        amountRaised += amount;</span><br><span class=\"line\">        tokenReward.<span class=\"title function_\">transfer</span>(msg.<span class=\"property\">sender</span>, amount / price);</span><br><span class=\"line\">        <span class=\"title class_\">FundTransfer</span>(msg.<span class=\"property\">sender</span>, amount, <span class=\"literal\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    *  定义函数修改器modifier（作用和Python的装饰器很相似）</span></span><br><span class=\"line\"><span class=\"comment\">    * 用于在函数执行前检查某种前置条件（判断通过之后才会继续执行该方法）</span></span><br><span class=\"line\"><span class=\"comment\">    * _ 表示继续执行之后的代码</span></span><br><span class=\"line\"><span class=\"comment\">    **/</span></span><br><span class=\"line\">    modifier <span class=\"title function_\">afterDeadline</span>(<span class=\"params\"></span>) &#123; <span class=\"keyword\">if</span> (now &gt;= deadline) _; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 判断众筹是否完成融资目标， 这个方法使用了afterDeadline函数修改器</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">function</span> <span class=\"title function_\">checkGoalReached</span>(<span class=\"params\"></span>) afterDeadline &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (amountRaised &gt;= fundingGoal) &#123;</span><br><span class=\"line\">            fundingGoalReached = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            <span class=\"title class_\">GoalReached</span>(beneficiary, amountRaised);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        crowdsaleClosed = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 完成融资目标时，融资款发送到收款方</span></span><br><span class=\"line\"><span class=\"comment\">     * 未完成融资目标时，执行退款</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">function</span> <span class=\"title function_\">safeWithdrawal</span>(<span class=\"params\"></span>) afterDeadline &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!fundingGoalReached) &#123;</span><br><span class=\"line\">            uint amount = balanceOf[msg.<span class=\"property\">sender</span>];</span><br><span class=\"line\">            balanceOf[msg.<span class=\"property\">sender</span>] = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (amount &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (msg.<span class=\"property\">sender</span>.<span class=\"title function_\">send</span>(amount)) &#123;</span><br><span class=\"line\">                    <span class=\"title class_\">FundTransfer</span>(msg.<span class=\"property\">sender</span>, amount, <span class=\"literal\">false</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    balanceOf[msg.<span class=\"property\">sender</span>] = amount;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (fundingGoalReached &amp;&amp; beneficiary == msg.<span class=\"property\">sender</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (beneficiary.<span class=\"title function_\">send</span>(amountRaised)) &#123;</span><br><span class=\"line\">                <span class=\"title class_\">FundTransfer</span>(beneficiary, amountRaised, <span class=\"literal\">false</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//If we fail to send the funds to beneficiary, unlock funders balance</span></span><br><span class=\"line\">                fundingGoalReached = <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"部署及说明\"><a href=\"#部署及说明\" class=\"headerlink\" title=\"部署及说明\"></a>部署及说明</h2><p>在部署这个合约之前，我们需要先部署一个代币合约，请参考一步步教你创建自己的数字货币。</p>\n<ol>\n<li>创建众筹合约我们需要提供一下几个参数：<br>ifSuccessfulSendTo： 募资成功后的收款方（其实这里可以默认为合约创建者）<br>fundingGoalInEthers： 募资额度， 为了方便我们仅募3个ether<br>durationInMinutes： 募资时间<br>finneyCostOfEachToken 每个代币的价格, 这里为了方便使用了单位finney及值为：1 （1 ether &#x3D; 1000 finney）<br>addressOfTokenUsedAsReward： 代币合约地址。<br>如：</li>\n</ol>\n<p>  <img src=\"/img/crowdsale_create.jpeg\"></p>\n<pre><code> 本文使用的参数为：\n\n <figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;0xc6f9ea59d424733e8e1902c7837ea75e20abfb49&quot;,3, 100, 1,&quot;0xad8972e2b583f580fc52f737b98327eb65d08f8c&quot;</span><br></pre></td></tr></table></figure>\n</code></pre>\n<ol start=\"2\">\n<li>参与人投资的时候实际购买众筹合约代币，所有需要先向合约预存代币，代币的数量为：募资额度 &#x2F; 代币的价格 ， 这里为：3 * 1000&#x2F;1 &#x3D; 3000 （当能也可以大于3000）。<br>向合约预存代币可以使用<a href=\"https://www.myetherwallet.com/#send-transaction\">myetherwallet</a>钱包，或在remix中重新加载代币合约，执行代币合约tranfer()函数进行代币转账。如使用myetherwallet转账如图：</li>\n</ol>\n<p>  <img src=\"/img/crowdsale_send_token.jpeg\"></p>\n<ol start=\"3\">\n<li><p>参参与人投资行为即是向买众筹合约转账，转账时，会执行Fallback回退函数（即无名函数）向其账户打回相应的代币。</p>\n</li>\n<li><p>safeWithdrawl() 可以被参与人或收益人执行，如果融资不达标参与人可收回之前投资款，如果融资达标收益人可以拿到所有的融资款。</p>\n</li>\n</ol>\n<h2 id=\"参考文档\"><a href=\"#参考文档\" class=\"headerlink\" title=\"参考文档\"></a>参考文档</h2><ul>\n<li><a href=\"https://ethereum.org/crowdsale\">Create a crowdsale</a></li>\n</ul>\n","categories":[{"name":"学习记录","path":"api/categories/学习记录.json"},{"name":"区块链","path":"api/categories/区块链.json"},{"name":"以太坊","path":"api/categories/以太坊.json"}],"tags":[{"name":"以太坊","path":"api/tags/以太坊.json"}]}